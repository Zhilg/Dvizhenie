<link rel="stylesheet" href="../assets/css/bootstrap.min.css">
<link rel="stylesheet" href="../assets/css/semantic_analysis.css">

<div class="container mt-4">
    <h1 class="mb-4">Семантический анализ документов</h1>
    
    <div class="border p-4 rounded bg-light mb-4">
        <!-- Блок загрузки документов -->
        <div class="mb-4">
            <h3><i class="bi bi-upload"></i> Загрузка документов</h3>
            <div class="mb-3">
                <label class="form-label fw-bold">Название коллекции:</label>
                <input type="text" id="collectionName" class="form-control" placeholder="Введите название коллекции">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Выберите папку с документами:</label>
                <div class="input-group">
                    <input type="file" id="folderInput" class="form-control" webkitdirectory directory multiple
                           style="display: none;">
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="document.getElementById('folderInput').click()">
                        <i class="bi bi-folder2-open"></i> Выбрать папку
                    </button>
                    <input type="text" class="form-control" id="folderName" placeholder="Папка не выбрана" readonly>
                </div>
                <div class="form-text">Поддерживается в Chrome и Edge</div>
            </div>
            <button id="uploadBtn" class="btn btn-primary">
                <i class="bi bi-cloud-upload"></i> Загрузить документы
            </button>
        </div>
        
        <!-- Блок поиска -->
        <div class="mb-4">
            <h3><i class="bi bi-search"></i> Поиск по коллекции</h3>
            <div class="mb-3">
                <label class="form-label fw-bold">Выберите коллекцию:</label>
                <select id="collectionSelect" class="form-select">
                    <option value="">-- Загрузите коллекции --</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="searchQuery" class="form-label fw-bold">Поисковый запрос:</label>
                <textarea id="searchQuery" class="form-control" rows="3" 
                          placeholder="Введите текст для поиска"></textarea>
            </div>
            <button id="searchBtn" class="btn btn-primary">
                <i class="bi bi-search"></i> Найти
            </button>
        </div>
        
        <!-- Блок управления коллекциями -->
        <div>
            <h3><i class="bi bi-collection"></i> Управление коллекциями</h3>
            <button id="listCollectionsBtn" class="btn btn-outline-info me-2">
                <i class="bi bi-list-ul"></i> Показать коллекции
            </button>
            <button id="deleteCollectionBtn" class="btn btn-outline-danger me-2">
                <i class="bi bi-trash"></i> Удалить коллекцию
            </button>
            <button id="deleteAllCollectionsBtn" class="btn btn-outline-danger">
                <i class="bi bi-trash-fill"></i> Удалить все
            </button>
        </div>
    </div>
    
    <!-- Результаты -->
    <div id="resultsContainer" class="mt-4" style="display: none;">
        <h3><i class="bi bi-graph-up"></i> Результаты анализа</h3>
        <div id="uploadResults" class="alert alert-info mb-3" style="display: none;"></div>
        <div id="searchResults" class="mb-3" style="display: none;"></div>
        <div id="collectionList" class="alert alert-secondary" style="display: none;"></div>
    </div>

    <div id="uploadProgress" class="mt-3"></div>


    <button id="deleteCollectionBtn" class="btn btn-outline-danger me-2">
    <i class="bi bi-trash"></i> Удалить корпус
    </button>
</div>

<script>
const BASE_URL = "/api/semantic"; 
// Глобальные переменные
let currentJobId = null;
let currentCorpusId = null;
let currentModelId = 'default-model';
let checkStatusInterval = null;

// Обновленная функция загрузки документов
async function uploadDocuments() {
  if (!folderInput.files.length) {
    showError('Пожалуйста, выберите папку с документами');
    return;
  }

  showLoading(uploadBtn);

  try {
    const formData = new FormData();
    for (let i = 0; i < folderInput.files.length; i++) {
      formData.append('files', folderInput.files[i]);
    }

    const response = await fetch('/api/semantic/upload', {
      method: 'POST',
      headers: {
        'x-model-id': currentModelId,
        'x-ttl-hours': '24'
      },
      body: formData
    });

    if (!response.ok) throw new Error(await response.text());

    const data = await response.json();
    currentJobId = data.job_id;

    uploadResults.innerHTML = `
      <h4 class="alert-heading">Загрузка начата</h4>
      <p><strong>ID задачи:</strong> ${currentJobId}</p>
      <p><strong>Примерное время:</strong> ${data.estimated_time_min || 'неизвестно'} минут</p>
      <div id="uploadProgress"></div>
    `;
    
    // Запускаем проверку статуса
    checkStatusInterval = setInterval(checkUploadStatus, 5000);
    
  } catch (error) {
    console.error("Upload error:", error);
    showError('Ошибка загрузки: ' + error.message);
  } finally {
    resetButton(uploadBtn, '<i class="bi bi-cloud-upload"></i> Загрузить документы');
  }
}

// Проверка статуса загрузки
async function checkUploadStatus() {
  try {
    const response = await fetch(`/api/jobs/${currentJobId}`);
    const status = await response.json();
    
    const progressDiv = document.getElementById('uploadProgress');
    if (progressDiv) {
      progressDiv.innerHTML = `
        <p><strong>Статус:</strong> ${status.status}</p>
        ${status.progress ? `<p>Прогресс: ${status.progress.toFixed(1)}%</p>` : ''}
        ${status.details ? `
          <p>Обработано файлов: ${status.details.files_processed || 0}</p>
          <p>Объем данных: ${(status.details.bytes_processed / (1024**3)).toFixed(2)} GB</p>
        ` : ''}
      `;
    }
    
    if (status.status === 'completed') {
      clearInterval(checkStatusInterval);
      await getUploadResults(status.result_url);
    }
    
  } catch (error) {
    console.error("Status check error:", error);
    clearInterval(checkStatusInterval);
    showError('Ошибка проверки статуса: ' + error.message);
  }
}

// Получение результатов загрузки
async function getUploadResults(resultUrl) {
  try {
    const response = await fetch(`/api/results${resultUrl}`);
    const results = await response.json();
    currentCorpusId = results.corpus_id;
    
    uploadResults.innerHTML += `
      <div class="alert alert-success mt-3">
        <h4>Загрузка завершена</h4>
        <p><strong>ID корпуса:</strong> ${results.corpus_id}</p>
        <p><strong>Файлов:</strong> ${results.file_count}</p>
        <p><strong>Размер индекса:</strong> ${results.index_stats.total_size_gb} GB</p>
      </div>
    `;
    
    // Обновляем список корпусов
    await updateCorporaList();
    
  } catch (error) {
    console.error("Results error:", error);
    showError('Ошибка получения результатов: ' + error.message);
  }
}

// Обновленная функция поиска
async function searchDocuments() {
  if (!currentCorpusId) {
    showError('Пожалуйста, сначала загрузите документы');
    return;
  }

  if (!searchQuery.value) {
    showError('Пожалуйста, введите поисковый запрос');
    return;
  }

  showLoading(searchBtn);

  try {
    const response = await fetch('/api/semantic/search', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain; charset=utf-8',
        'x-corpus-id': currentCorpusId,
        'x-result-amount': '5',
        'x-model-id': currentModelId
      },
      body: searchQuery.value
    });

    if (!response.ok) throw new Error(await response.text());

    const results = await response.json();
    displaySearchResults(results);
    
  } catch (error) {
    console.error("Search error:", error);
    showError('Ошибка поиска: ' + error.message);
  } finally {
    resetButton(searchBtn, '<i class="bi bi-search"></i> Найти');
  }
}

// Отображение результатов поиска
function displaySearchResults(results) {
  let html = `
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Документ</th>
            <th>Фрагмент</th>
            <th>Сходство</th>
          </tr>
        </thead>
        <tbody>
  `;

  results.results.forEach(result => {
    html += `
      <tr>
        <td>
          <strong>${result.file_id}</strong><br>
          <small class="text-muted">${result.fragment || ''}</small>
        </td>
        <td>${result.preview || ''}</td>
        <td>${result.score.toFixed(4)}</td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>
    <p class="mt-2">Найдено результатов: ${results.results.length}</p>
  `;

  searchResults.innerHTML = html;
  searchResults.style.display = 'block';
  resultsContainer.style.display = 'block';
}

// Обновление списка корпусов
async function updateCorporaList() {
  try {
    const response = await fetch('/api/semantic/corpora');
    const corpora = await response.json();
    
    let html = '<h4>Доступные корпуса:</h4><ul class="list-group">';
    corpora.forEach(corpus => {
      html += `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          ${corpus.name || corpus.id}
          <span class="badge bg-primary rounded-pill">${corpus.file_count} файлов</span>
        </li>
      `;
    });
    html += '</ul>';
    
    collectionList.innerHTML = html;
    collectionList.style.display = 'block';
    
  } catch (error) {
    console.error("Corpora list error:", error);
    collectionList.innerHTML = `
      <div class="alert alert-danger">
        Ошибка получения списка корпусов: ${error.message}
      </div>
    `;
  }
}

// Удаление корпуса
async function deleteCorpus() {
  if (!currentCorpusId) {
    showError('Нет активного корпуса для удаления');
    return;
  }

  if (!confirm(`Удалить корпус ${currentCorpusId}?`)) return;

  showLoading(deleteCollectionBtn);

  try {
    const response = await fetch(`/api/semantic/corpora/${currentCorpusId}`, {
      method: 'DELETE'
    });

    if (!response.ok) throw new Error(await response.text());

    collectionList.innerHTML = `
      <div class="alert alert-success">
        Корпус успешно удален
      </div>
    `;
    
    currentCorpusId = null;
    await updateCorporaList();
    
  } catch (error) {
    console.error("Delete error:", error);
    showError('Ошибка удаления: ' + error.message);
  } finally {
    resetButton(deleteCollectionBtn, '<i class="bi bi-trash"></i> Удалить корпус');
  }
}

// Инициализация
document.addEventListener('DOMContentLoaded', async () => {
  await updateCorporaList();
  
  // Обновленные обработчики
  uploadBtn.addEventListener('click', uploadDocuments);
  searchBtn.addEventListener('click', searchDocuments);
  deleteCollectionBtn.addEventListener('click', deleteCorpus);
  listCollectionsBtn.addEventListener('click', updateCorporaList);
});
</script>
